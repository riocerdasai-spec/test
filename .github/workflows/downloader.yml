name: API Video Downloader

on:
  # Trigger 1: Untuk API (Webhook)
  repository_dispatch:
    types: [download-video-request]
  
  # Trigger 2: Untuk Manual (Klik di GitHub)
  workflow_dispatch:
    inputs:
      video_url:
        description: 'URL Video'
        required: true
      format_code:
        description: 'Format'
        default: 'bv+ba/b'

jobs:
  process_video:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # 1. Logika untuk menentukan URL (dari API atau Manual)
    - name: Set Variables
      id: vars
      run: |
        if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
          echo "Triggered via API"
          echo "URL=${{ github.event.client_payload.video_url }}" >> $GITHUB_ENV
          echo "FMT=${{ github.event.client_payload.format_code || 'bv+ba/b' }}" >> $GITHUB_ENV
        else
          echo "Triggered via Manual Button"
          echo "URL=${{ inputs.video_url }}" >> $GITHUB_ENV
          echo "FMT=${{ inputs.format_code }}" >> $GITHUB_ENV
        fi

    # 2. Setup Environment
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Install FFmpeg & yt-dlp (Versi Master/Nightly)
    - name: Install Tools
      run: |
        sudo apt-get update && sudo apt-get install -y ffmpeg
        pip install https://github.com/yt-dlp/yt-dlp/archive/master.zip

    # 4. Download Video (Dengan Fix Android Client & Safe Cookie Check)
    - name: Download Video
      env:
        # Mengambil secret ke variable environment (Aman dari error syntax YAML)
        MY_COOKIES: ${{ secrets.YOUTUBE_COOKIES }}
      run: |
        mkdir downloads
        
        # Cek apakah cookies ada isinya
        if [ -n "$MY_COOKIES" ]; then
          echo "$MY_COOKIES" > cookies.txt
          COOKIE_CMD="--cookies cookies.txt"
          echo "✅ Cookies ditemukan. Menggunakan autentikasi."
        else
          COOKIE_CMD=""
          echo "⚠️ Cookies kosong. Mencoba download tanpa login."
        fi

        echo "Processing: $URL"
        
        # COMMAND UTAMA
        # --extractor-args "youtube:player_client=android" adalah kunci bypass error "Only images"
        
        yt-dlp "$URL" \
          $COOKIE_CMD \
          -f "$FMT" \
          --merge-output-format mp4 \
          -o "downloads/%(title)s.%(ext)s" \
          --no-playlist \
          --extractor-args "youtube:player_client=android"

    # 5. Upload ke Cloudflare R2
    - name: Upload to R2
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_KEY }}
        AWS_DEFAULT_REGION: auto
      run: |
        echo "Mengupload ke Bucket..."
        ENDPOINT_URL="https://${{ secrets.CF_ACCOUNT_ID }}.r2.cloudflarestorage.com"
        
        aws s3 cp downloads/ s3://${{ secrets.R2_BUCKET_NAME }}/ --recursive --endpoint-url $ENDPOINT_URL --no-progress
        
        echo "Upload Selesai!"

    # 6. Bersih-bersih
    - name: Cleanup
      if: always()
      run: rm -rf downloads cookies.txt
